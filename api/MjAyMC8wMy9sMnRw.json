{"title":"L2TP/IPSec一键安装脚本","date":"2020-03-12T21:00:00.000Z","date_formatted":{"ll":"2020年3月12日","L":"2020/03/12","MM-DD":"03-12"},"link":"2020/03/l2tp","updated":"2020-09-19T13:31:15.128Z","content":"<h4 id=\"本脚本适用环境：\">本脚本适用环境：<a title=\"#本脚本适用环境：\" href=\"#本脚本适用环境：\"></a></h4>\n<p>系统支持：CentOS6+，Debian7+，Ubuntu12+<br>\n内存要求：≥128M<br>\n更新日期：2017 年 05 月 28 日</p>\n<h4 id=\"关于本脚本：\">关于本脚本：<a title=\"#关于本脚本：\" href=\"#关于本脚本：\"></a></h4>\n<p>名词解释如下<br>\nL2TP（Layer 2 Tunneling Protocol）<br>\nIPSec（Internet Protocol Security）<br>\nIKEv2 (Internet Key Exchange v2)<br>\n能实现 IPsec 的目前总体上有 openswan，libreswan，strongswan 这3种。<br>\nlibreswan 是基于 openswan 的 fork，所以现在各个发行版基本已经看不到 openswan 的身影了。<br>\n当然也有使用 strongswan 的。</p>\n<p>之所以要更新 L2TP 一键安装脚本，是因为随着各个 Linux 发行版不断推陈出新，原有的脚本已经不适应现在的需求。<br>\n本脚本通过编译安装最新版 libreswan 来实现 IPSec（CentOS7 下则是全部 yum 安装），yum 或 apt-get 来安装 xl2tpd，再根据各个发行版的使用方法不同，部署防火墙规则。</p>\n<h4 id=\"写在前面：\">写在前面：<a title=\"#写在前面：\" href=\"#写在前面：\"></a></h4>\n<p>基于 OpenVZ 虚拟化技术的 VPS 需要开启TUN/TAP才能正常使用，购买 VPS 时请先咨询服务商是否支持开启 TUN/TAP。</p>\n<p>OpenVZ 虚拟的 VPS 需要系统内核支持 IPSec 才行。也就是说，母服务器的内核如果不支持的话那就没办法，只能换 VPS。<br>\n因此，一般不建议在 OpenVZ 的 VPS 上安装本脚本。脚本如果检测到该 VPS 为 OpenVZ 架构，会出现警告提醒。</p>\n<h6 id=\"如何检测是否支持tun模块？\">如何检测是否支持TUN模块？<a title=\"#如何检测是否支持tun模块？\" href=\"#如何检测是否支持tun模块？\"></a></h6>\n<p>执行命令：<br>\n<code>cat /dev/net/tun</code><br>\n如果返回信息为：<br>\ncat: /dev/net/tun: File descriptor in bad state<br>\n说明正常</p>\n<h6 id=\"如何检测是否支持ppp模块？\">如何检测是否支持ppp模块？<a title=\"#如何检测是否支持ppp模块？\" href=\"#如何检测是否支持ppp模块？\"></a></h6>\n<p>执行命令：<br>\n<code>cat /dev/ppp</code><br>\n如果返回信息为：cat: /dev/ppp: No such device or address 说明正常</p>\n<p>当然，脚本在安装时也会执行检查，如果不适用于安装，脚本会予以提示。</p>\n<h4 id=\"使用方法：\">使用方法：<a title=\"#使用方法：\" href=\"#使用方法：\"></a></h4>\n<p>root 用户登录后，运行以下命令：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget --no-check-certificate https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;teddysun&#x2F;across&#x2F;master&#x2F;l2tp.sh</span><br><span class=\"line\">chmod +x l2tp.sh</span><br><span class=\"line\">.&#x2F;l2tp.sh</span><br></pre></td></tr></table></figure>\n<p>执行后，会有如下交互界面<br>\n<img src=\"https://teddysun.com/wp-content/uploads/2016/l2tp_1.png\" width=400></p>\n<p>Please input IP-Range:<br>\n(Default Range: 192.168.18):<br>\n输入本地IP段范围（本地电脑连接到VPS后给分配的一个本地IP地址），直接回车意味着输入默认值192.168.18</p>\n<p>Please input PSK:<br>\n(Default PSK: <a href=\"http://teddysun.com\">teddysun.com</a>):<br>\nPSK意为预共享密钥，即指定一个密钥将来在连接时需要用到，<a href=\"http://xn--teddysun-273my9g0rmhqhcy9a0thos9e48aq12uveosyae38u.com\">直接回车意味着输入默认值teddysun.com</a></p>\n<p>Please input Username:<br>\n(Default Username: teddysun):<br>\nUsername意为用户名，即第一个默认用户。直接回车意味着输入默认值teddysun</p>\n<p>Please input teddysun’s password:<br>\n(Default Password: Q4SKhu2EXQ):<br>\n输入用户的密码，默认会随机生成一个10位包含大小写字母和数字的密码，当然你也可以指定密码。</p>\n<p>ServerIP:your_server_main_IP<br>\n显示你的 VPS 的主 IP（如果是多 IP 的 VPS 也只显示一个）</p>\n<p>Server Local IP:192.168.18.1<br>\n显示你的 VPS 的本地 IP（默认即可）</p>\n<p>Client Remote IP Range:192.168.18.2-192.168.18.254<br>\n显示 IP 段范围</p>\n<p>PSK:teddysun.com<br>\n显示 PSK</p>\n<p>Press any key to start…or Press Ctrl+c to cancel<br>\n按下任意按键继续，如果想取消安装，请按Ctrl+c键</p>\n<p>安装完成后，脚本会执行 ipsec verify 命令并提示如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">If there are no [FAILED] above, then you can connect to your</span><br><span class=\"line\">L2TP VPN Server with the default Username&#x2F;Password is below:</span><br><span class=\"line\"></span><br><span class=\"line\">ServerIP:your_server_IP</span><br><span class=\"line\">PSK:your PSK</span><br><span class=\"line\">Username:your usename</span><br><span class=\"line\">Password:your password</span><br><span class=\"line\"></span><br><span class=\"line\">If you want to modify user settings, please use command(s):</span><br><span class=\"line\">l2tp -a (Add a user)</span><br><span class=\"line\">l2tp -d (Delete a user)</span><br><span class=\"line\">l2tp -l (List all users)</span><br><span class=\"line\">l2tp -m (Modify a user password)</span><br><span class=\"line\">Welcome to visit https:&#x2F;&#x2F;teddysun.com&#x2F;448.html</span><br><span class=\"line\">Enjoy it!</span><br></pre></td></tr></table></figure>\n<p>如果你要想对用户进行操作，可以使用如下命令：<br>\nl2tp -a 新增用户<br>\nl2tp -d 删除用户<br>\nl2tp -m 修改现有的用户的密码<br>\nl2tp -l 列出所有用户名和密码<br>\nl2tp -h 列出帮助信息</p>\n<h6 id=\"其他事项：\">其他事项：<a title=\"#其他事项：\" href=\"#其他事项：\"></a></h6>\n<p>1、脚本在安装完成后，已自动启动进程，并加入了开机自启动。<br>\n2、脚本会改写 iptables 或 firewalld 的规则。<br>\n3、脚本安装时，会即时将安装日志写到 /root/l2tp.log 文件里，如果你安装失败，可以通过此文件来寻找错误信息。</p>\n<h6 id=\"使用命令：\">使用命令：<a title=\"#使用命令：\" href=\"#使用命令：\"></a></h6>\n<p>ipsec status （查看 IPSec 运行状态）<br>\nipsec verify （查看 IPSec 检查结果）<br>\n/etc/init.d/ipsec start|stop|restart|status （CentOS6 下使用）<br>\n/etc/init.d/xl2tpd start|stop|restart （CentOS6 下使用）<br>\nsystemctl start|stop|restart|status ipsec （CentOS7 下使用）<br>\nsystemctl start|stop|restart xl2tpd （CentOS7 下使用）<br>\nservice ipsec start|stop|restart|status （Debian/Ubuntu 下使用）<br>\nservice xl2tpd start|stop|restart （Debian/Ubuntu 下使用）</p>\n<h6 id=\"更新日志\">更新日志<a title=\"#更新日志\" href=\"#更新日志\"></a></h6>\n<p>2017 年 05 月 28 日：<br>\n升级 libreswan 到版本 3.20。<br>\n修正 libreswan 的若干配置问题。<br>\n修正 xl2tpd 的端口监听配置问题。<br>\n修正在 CentOS 6 对 libevent2 的依赖问题，改为 yum 安装 libevent2-devel。<br>\n测试表明，在内网环境的 VPS 里（如AWS， IDCF，GCE，腾讯云，阿里云等）也可以正常使用了。</p>\n<p>2017 年 02 月 25 日：<br>\n升级 libreswan 到版本 3.19。</p>\n<p>2016 年 09 月 12 日：<br>\n修正了在 CentOS 6 下 libevent2 依赖的问题；<br>\n新增了一个 -m 选项，用以修改现有用户的密码。</p>\n<p>2016 年 08 月 13 日：<br>\n修正 Debian 8 下的 sd-daemon.h: No such file or directory 问题，是由于缺少依赖包 libsystemd-daemon-dev 导致的。</p>\n<p>2016 年 08 月 05 日：<br>\n升级 libreswan 到版本 3.18。</p>\n<p>2016 年 06 月 10 日：<br>\n脚本在安装完成后，新增了几个命令，便于操作用户<br>\nl2tp -a 新增用户<br>\nl2tp -d 删除用户<br>\nl2tp -l 列出所有用户<br>\nl2tp -h 列出帮助信息</p>\n<p>2016 年 04 月 25 日：<br>\n4、在 Vultr 的 Debian 7的系统模板下安装时，软件包 libcurl4-nss-dev 会出现依赖错误。如下所示：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">The following packages have unmet dependencies:</span><br><span class=\"line\">libcurl4-nss-dev : Depends: libldap2-dev but it is not going to be installed</span><br><span class=\"line\">Depends: librtmp-dev but it is not going to be installed</span><br></pre></td></tr></table></figure>\n<p>而 libldap2-dev 和 librtmp-dev 又依赖了其他几种软件包。总之最后的依赖关系如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">libldap2-dev : Depends: libldap-2.4-2 (&#x3D; 2.4.31-2+deb7u1) but 2.4.31+really2.4.40+dfsg-1+deb8u1~bpo70+1 is to be installed</span><br><span class=\"line\">librtmp-dev : Depends: libgnutls-dev but it is not going to be installed</span><br><span class=\"line\">libgnutls-dev : Depends: libp11-kit-dev (&gt;&#x3D; 0.4) but it is not going to be installed</span><br><span class=\"line\">libp11-kit-dev : Depends: libp11-kit0 (&#x3D; 0.12-3) but 0.20.7-1~bpo70+1 is to be installed</span><br></pre></td></tr></table></figure>\n<p>那么解决办法就是把最底层的依赖包 libp11-kit0 先卸载掉，然后再安装 libcurl4-nss-dev 即可。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get -y remove libp11-kit0</span><br><span class=\"line\">apt-get -y --no-install-recommends install libcurl4-nss-dev wget</span><br></pre></td></tr></table></figure>\n<p>然后再运行脚本安装即可。</p>\n<p>2016 年 04 月 22 日：<br>\n修复了在 Ubuntu 16.04 下因为默认缺少 python 命令而导致 ipsec verify 等命令不能用的问题。</p>\n<p>2016 年 04 月 19 日：<br>\n修复了在 Debian 7 下因为 libnss3 和 libnspr4 的版本过低而导致编译 libreswan 失败的问题。</p>\n<p>2016 年 04 月 18 日：<br>\n目前在 Debian 7 上测试的结果，因为 libnss3 和 libnspr4 的版本过低而导致编译 libreswan 失败。临时解决办法是 dpkg 安装 libnss3_3.17.2 和 libnspr4_4.10.7 的 deb 包后重试。</p>\n<hr>\n<p>本内容来源于：<a href=\"https://teddysun.com/448.html\">https://teddysun.com/448.html</a></p>\n","prev":{"title":"Linux下的Vim使用教程","link":"2020/04/vim-help"},"next":{"title":"入手日版Nintendo Switch","link":"2020/01/Nintendo-Switch"},"plink":"https://www.shiguangping.com/2020/03/l2tp/"}