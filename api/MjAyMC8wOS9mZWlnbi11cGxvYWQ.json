{"title":"使用Spring Cloud Feign上传文件","date":"2020-09-06T23:00:00.000Z","date_formatted":{"ll":"2020年9月6日","L":"2020/09/06","MM-DD":"09-06"},"link":"2020/09/feign-upload","tags":["Spring-Cloud","Spring-Cloud-Alibaba"],"categories":["Java"],"updated":"2020-09-19T16:07:59.427Z","content":"<p>使用Spring Cloud Feign上传文件，早期的Spring Cloud中，Feign本身是没有上传文件的能力的，要想实现这一点，需要自己编写<code>Encoder</code>去实现上传。现在，Feign官方提供了子项目<a href=\"https://github.com/OpenFeign/feign-form\" target=\"_blank\">feign-form</a>，其中实现了上传所需的<code>Encoder</code>。</p>\n<blockquote>\n<p>注：笔者测试的版本是Edgware.RELEASE。Camden、Dalston同样适应本文所述。</p>\n</blockquote>\n<h2 id=\"加依赖\">加依赖<a title=\"#加依赖\" href=\"#加依赖\"></a></h2>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>io.github.openfeign.form<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>feign-form<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>3.0.3<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>io.github.openfeign.form<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>feign-form-spring<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>3.0.3<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"编写feign-client\">编写Feign Client<a title=\"#编写feign-client\" href=\"#编写feign-client\"></a></h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@FeignClient(name = &quot;ms-content-sample&quot;, configuration = UploadFeignClient.MultipartSupportConfig.class)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">UploadFeignClient</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(value = &quot;/upload&quot;, method = RequestMethod.POST,</span></span><br><span class=\"line\"><span class=\"meta\">            produces = &#123;MediaType.APPLICATION_JSON_UTF8_VALUE&#125;,</span></span><br><span class=\"line\"><span class=\"meta\">            consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class=\"line\">    <span class=\"meta\">@ResponseBody</span></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">handleFileUpload</span><span class=\"params\">(<span class=\"meta\">@RequestPart(value = &quot;file&quot;)</span> MultipartFile file)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MultipartSupportConfig</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"meta\">@Bean</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> Encoder <span class=\"title\">feignFormEncoder</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> SpringFormEncoder();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>如代码所示，在这个Feign Client中，我们引用了配置类<code>MultipartSupportConfig</code>，在<code>MultipartSupportConfig</code>中，我们实例化了<code>SpringFormEncoder</code>。这样这个Feign Client就能够上传了。</p>\n<p><strong>注意点：</strong></p>\n<ul>\n<li>\n<pre><code class=\"language-java\">@RequestMapping(value = &quot;/upload&quot;, method = RequestMethod.POST,\n            produces = &#123;MediaType.APPLICATION_JSON_UTF8_VALUE&#125;,\n            consumes = MediaType.MULTIPART_FORM_DATA_VALUE)\n</code></pre>\n<p>这里的<code>produces</code>、<code>consumes</code>不能少；</p>\n</li>\n<li>\n<p>方法参数列表中的注解<code>@RequestPart(value = &quot;file&quot;)</code>不能写成<code>@RequestParam(value = &quot;file&quot;)</code>；</p>\n</li>\n<li>\n<p>最好将Hystrix的超时时间设长一点，例如5秒，否则可能文件还没上传完，Hystrix就超时了，从而导致客户端侧的报错。</p>\n</li>\n</ul>\n","prev":{"title":"Vue组件间通信","link":"2020/09/vue-components-communication"},"next":{"title":"IDEA中的Web项目移动到Eclipse","link":"2020/06/ideaproj-to-eclipse"},"plink":"https://www.shiguangping.com/2020/09/feign-upload/","toc":[{"id":"加依赖","title":"加依赖","index":"1"},{"id":"编写feign-client","title":"编写Feign Client","index":"2"}]}